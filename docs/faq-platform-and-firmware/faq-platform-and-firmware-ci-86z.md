# CI-86Z 平台与固件 FAQ

本页用于整理 CI-86Z 相关的平台配置与固件问题。

### CI-86Z系列芯片内存版本如何区分？

**问题描述：**

CI-86Z系列芯片有1M和2M两种内存版本，需要准确区分以避免使用错误的固件。

**区分方法：**

1. **型号识别**：

    - CI-86Z1：1M Flash版本
    - CI-86Z2：2M Flash版本

2. **固件兼容性**：

    - 1M版本固件无法在2M版本上使用
    - 2M版本固件向下兼容1M硬件（但功能受限）
    - 选择固件时必须与硬件版本匹配

3. **选型建议**：

    - 功能简单：选择1M版本
    - 需要更多存储空间：选择2M版本
    - 不确定时选择2M版本以预留扩展空间

---

### 多MCU与语音模块通信时数据冲突如何解决？

**问题描述：**

多个MCU同时向语音模块发送串口数据时，导致数据混合、错乱，影响小程序界面显示和语音功能正常使用。

**问题现象：**

1. **数据混合**：两个MCU同时发送数据（如11 22 33），会混合成11 44 66 33等错误数据
2. **界面错乱**：小程序接收到错误数据后显示错误的功能界面
3. **语音失效**：由于数据错误，语音控制功能无法正常工作
4. **识别错误**：模块将错误的命令识别为其他功能指令

**技术原因分析：**

1. **串口冲突**：

    - 多个MCU共享同一个串口向模块发送数据
    - 没有做好数据同步机制
    - 数据发送时机重叠导致字节级交错

2. **协议重复**：

    - 不同功能的回复数据使用相同的协议头（如82 01）
    - 查询回复与操作指令数据格式冲突
    - 缺乏有效的数据校验机制

**解决方案：**

1. **硬件连接优化**：

    **级联连接方案**：
    ```
    MCU1 ←→ MCU2 ←→ 语音模块
    ```
    - MCU1与MCU2相连
    - MCU2负责转发MCU1的数据
    - 语音模块仅连接MCU2
    - 实现数据的统一管理和转发

2. **协议设计优化**：

    **区分数据类型**：

    - 使用不同的协议头区分不同功能
    - 查询回复：82 0B XX XX XX
    - 操作指令：82 01 XX XX XX
    - 确保每类数据有唯一标识

    **添加数据校验**：

    - 在数据包中添加校验和
    - 使用帧头帧尾标记数据边界
    - 实现数据完整性验证

3. **软件时序控制**：

    **数据发送同步**：

    - MCU之间建立握手机制
    - 确保同一时间只有一个MCU发送数据
    - 使用忙信号线防止数据冲突

    **缓冲队列管理**：

    - 为每个MCU建立独立的数据缓冲区
    - 采用轮询或优先级机制处理数据
    - 避免数据丢失或延迟

**实施建议：**

1. **设计阶段**：

    - 提前规划数据通信协议
    - 设计防冲突机制
    - 预留扩展空间

2. **开发阶段**：

    - 实现数据发送的互斥控制
    - 添加调试日志便于问题排查
    - 进行充分的压力测试

3. **测试验证**：

    - 模拟各种并发场景
    - 验证数据完整性
    - 确保系统稳定性

**注意事项：**

- 修改协议需要同时更新相关的语音指令配置
- 生产前需要进行充分的兼容性测试
- 考虑未来功能扩展对通信协议的影响
- 建议使用标准的通信框架简化开发

---

### CI-86Z被动播报模式如何配置？

**问题描述：**

需要将语音模块从主动播报模式改为被动播报模式，即根据MCU返回的数据来决定是否播报及播报内容。

**配置方案：**

1. **主动播报vs被动播报**：

    **主动播报**：

    - 模块识别到命令后立即播报
    - 不依赖MCU返回数据
    - 响应速度快，但灵活性差

    **被动播报**：

    - 模块发送控制数据给MCU
    - 根据MCU返回数据决定播报内容
    - 灵活性高，便于后期维护

2. **配置方法**：

    **删除命令词主动播报**：

    - 在平台配置中取消命令词的主动播报
    - 保留串口发送功能
    - 设置被动播报触发条件

    **设置被动播报规则**：

    - 定义MCU返回数据格式
    - 配置数据与播报内容的映射关系
    - 设置超时处理机制

3. **优化建议**：

    **性能考虑**：

    - 被动播报会增加系统负载
    - 需要重写串口中断处理程序
    - 评估当前系统负载是否可承受

    **兼容性处理**：

    - 音乐播放等功能可能仍需主动播报
    - 混合模式：部分功能主动，部分功能被动
    - 儿童锁等特殊状态的处理

**注意事项：**

- 被动播报需要MCU配合开发
- 修改涉及面较大，建议在项目初期确定方案
- 充分测试各种边界情况
- 保留调试接口便于问题排查